services:
  math-mcp:
    build:
      context: .
      dockerfile: Dockerfile
    image: math-mcp:latest
    container_name: math-mcp-server
    restart: unless-stopped
    environment:
      # Transport mode: "stdio" or "streamable-http"
      # Use "streamable-http" for HTTP endpoint (compatible with mcp-remote)
      MCP_TRANSPORT: ${MCP_TRANSPORT:-streamable-http}
      
      # Host binding (0.0.0.0 = all interfaces, accessible from host and Docker network)
      MCP_HOST: ${MCP_HOST:-0.0.0.0}
      
      # Port to listen on inside container
      MCP_PORT: ${MCP_PORT:-8008}

      # Base directory for plot output files
      MCP_OUTPUT_DIR: ${MCP_OUTPUT_DIR:-/outputs/}
      
      # HTTP endpoint path
      MCP_PATH: ${MCP_PATH:-/mcp}
      
      # Allowed hosts (comma-separated)
      # Include port numbers if your Host headers include them
      MCP_ALLOWED_HOSTS: ${MCP_ALLOWED_HOSTS:-localhost,localhost:8008,host.docker.internal,host.docker.internal:8008,127.0.0.1,127.0.0.1:8008}
      
      # Set to "true" to disable DNS rebinding protection entirely (allows all hosts)
      # May be needed for @modelcontextprotocol/server-remote compatibility
      MCP_DISABLE_DNS_REBINDING_PROTECTION: ${MCP_DISABLE_DNS_REBINDING_PROTECTION:-true}
    ports:
      # Map host port to container port
      # Format: "host-port:container-port"
      # Change 8008:8008 to use a different host port (e.g., "9000:8008")
      - "${MCP_HOST_PORT:-8008}:${MCP_PORT:-8008}"
    volumes:
      # Mount output directory for plot files (using named volume)
      - "outputs:/outputs"
    networks:
      - math-mcp-network
    # Health check only works for HTTP transport mode
    # For stdio mode, set DISABLE_HEALTHCHECK=true in .env or remove this section
    healthcheck:
      # POST request with proper headers to initialize the MCP server
      test: ["CMD-SHELL", "python -c \"import urllib.request, json; req = urllib.request.Request('http://localhost:8008/mcp', data=json.dumps({'jsonrpc':'2.0','id':1,'method':'initialize','params':{'protocolVersion':'2024-11-05','capabilities':{},'clientInfo':{'name':'healthcheck','version':'1.0'}}}).encode(), headers={'Content-Type': 'application/json', 'Accept': 'application/json, text/event-stream'}); urllib.request.urlopen(req, timeout=5).read()\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
      disable: ${DISABLE_HEALTHCHECK:-false}

networks:
  math-mcp-network:
    name: math-mcp-network
    driver: bridge

volumes:
  outputs:
    driver: local
